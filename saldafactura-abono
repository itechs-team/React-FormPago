public fuction oRespuesta SaldaAbonoWeb(clave, importe, formapago, comentarios, fechaPago)

end function

Public Sub SaldaFactura(id_ingreso, abono, idDoc, formapago, cobrador, referencia, comentarios, fecha, tipoCambioFac, abonoTras, abonoRet, objetoImpuesto, )
    Dim abonoParcial, nodecimales, SumAbonos, cargosdet, abonos, cargos, numParcialidad, saldoAnt, saldoAntTrans, SumAbonosTrans, abonoParcialTras, saldoAntRet, abonoParcialRet, SumAbonosRet, ObjetoImp
    Dim cargoid
    
    numParcialidad = GetValue("select dbo.GetNumParcialidad(" & iddoc & ") as NumParcialidad", "NumParcialidad")
    '
    saldoAnt = GetValue("select dbo.GetSaldoComprobante(" & iddoc & ") as SaldoAnt", "SaldoAnt")
    
    cargosdet = getvalue("sp_cargosporfact 0" & iddoc, "id_cargo")
    ' nodecimales = la convercion a int del resultado de sp_configuracion No_decimales=2
    nodecimales = cint(getvalue("sp_configuracion","No_decimales"))

    abonoParcial = 0.1
    SumAbonos = abono

    abonoParcialTras = abonoTras
    abonoParcialRet = abonoRet

    ObjetoImp = objetoImpuesto

    if fecha = "" then fecha = date
    
    if cargosdet = "" then
        error = "Error la factura no tiene cargos..."
        return
    End if
    Do while SumAbonos > 0 and abonoParcial <> 0

        Set abonos = Server.CreateObject("ADODB.Recordset")
        strSQL = "sp_totalabonoscargos 0" & iddoc
        abonos.CursorLocation = adUseClient
        abonos.Open strSQL, cnn, adOpenForwardOnly, adLockReadOnly

        Set cargos = Server.CreateObject("ADODB.Recordset")
        strSQL = "sp_TotalCargosAbonos 0" & iddoc
        cargos.CursorLocation = adUseClient
        cargos.Open strSQL, cnn, adOpenForwardOnly, adLockReadOnly

            Do while not cargos.EOF and SumAbonos > 0 
                If IsNull(cargos("total")) then
                    If CDbl(cargos("totalcargo")) = CDbl(SumAbonos)then
                        abonoParcial = cargos("totalcargo")
                        SumAbonos = cargos("totalcargo") - SumAbonos
                    Else
                        If CDbl(cargos("totalcargo")) > CDbl(SumAbonos)then
                            abonoParcial = SumAbonos
                            SumAbonos = SumAbonos - abonoParcial
                        Else
                            If CDbl(cargos("totalcargo")) < CDbl(SumAbonos) And CDbl(cargos("totalcargo")) <> 0 then
                                abonoParcial = cargos("totalcargo")
                                SumAbonos = SumAbonos - cargos("totalcargo")

                                'EMPIEZA AQUI
                            Else
                              If(CDbl(cargos("totalcargo")) = CDbl(SumAbonos) and CDbl(SumAbonosTrans) = Empty and CDbl(SumAbonosRet) = Empty )     then
                                abonoParcial = cargos("totalcargo")
                                SumAbonos = cargos("totalcargo") - SumAbonos
                                
                                abonoParcialTras = 0
                                SumAbonosTrans = 0
                                
                                abonoParcialRet = 0
                                SumAbonosRet = 0
                              Else
                                If(CDbl(cargos("totalcargo")) > CDbl(SumAbonos) and CDbl(SumAbonosTrans) = Empty and CDbl(SumAbonosRet) = Empty )     then
                                  abonoParcial = SumAbonos
                                  SumAbonos = SumAbonos - abonoParcial
                                  
                                  abonoParcialTras = 0
                                  SumAbonosTrans = 0
                                  
                                  abonoParcialRet = 0
                                  SumAbonosRet = 0
                                Else
                                  If(CDbl(cargos("totalcargo")) < CDbl(SumAbonos) and CDbl(SumAbonosTrans) = Empty and CDbl(SumAbonosRet) = Empty )     then
                                    abonoParcial = cargos("totalcargo")
                                    SumAbonos = SumAbonos - cargos("totalcargo")

                                    abonoParcialTras = 0
                                    SumAbonosTrans = 0
                                    
                                    abonoParcialRet = 0
                                    SumAbonosRet = 0
                                  Else
                                abonoParcial = 0
                                abonoParcialTras = 0
                                abonoParcialRet = 0
                            End If
                          End If
                        End If
                      End If
                    End If
                  end if
                Else
                  If CDbl(cargos("total")) = CDbl(SumAbonos) then
                      abonoParcial = cargos("total")
                      SumAbonos = cargos("total") - SumAbonos
                    Else
                      If CDbl(cargos("total")) > CDbl(SumAbonos) then
                        abonoParcial = SumAbonos
                        SumAbonos = SumAbonos - abonoParcial
                      Else
                        If CDbl(cargos("total")) < CDbl(SumAbonos) and CDbl(cargos("total")) <> 0  then
                          abonoParcial = cargos("total")
                          SumAbonos = SumAbonos - cargos("total")
                        else
                          abonoParcial = 0
                          abonoParcialTras = 0
                          abonoParcialRet = 0
                        End If
                      End If
                  End If
                End If
                
                If abonoParcial <> 0 then'or abonoParcialTras <> 0 or abonoParcialRet <> 0 then
                    response.write "cls_doctoscc.asp sp_addabono " & abonoParcial & ",'" & cargos("id_cargo") & "','" & fecha & "', " & formapago & "," & cobrador & ", '" & referencia & "','" & comentarios & "'," & id_ingreso & "," & numParcialidad & "," & saldoAnt & "," & tipoCambioFac & ","& session("idusua") & "," & abonoParcialTras & "," & abonoParcialRet & "," & ObjetoImp &"" 'aï¿½adio id_ingreso 30/07/2018      
                    cnn.Execute "sp_addabono " & abonoParcial & ",'" & cargos("id_cargo") & "','" & fecha & "', " & formapago & "," & cobrador & ", '" & referencia & "','" & comentarios & "'," & id_ingreso & "," & numParcialidad & "," & saldoAnt & "," & tipoCambioFac & ","& session("idusua") & "," & abonoParcialTras & "," & abonoParcialRet & "," & ObjetoImp &"" 'aï¿½adio id_ingreso 30/07/2018      
                    
                    cargoid = cargos("id_cargo")
                End If
                cargos.MoveNext
            Loop
        cargos.Close
        abonos.Close
    Loop
    
    If SumAbonos > 0.01 then'or SumAbonosTrans > 0.01 or SumAbonosRet > 0.01 then
        error = "El abono sobrepasa el saldo de la factura " & SumAbonos & "" '& SumAbonosTrans & "," & SumAbonosRet
    End if

end sub
